<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
	<meta name="referrer" content="no-referrer" />
    <meta name="keywords" content="谷粒商城分布式微服务组件K8s, Hexo">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>谷粒商城分布式微服务组件K8s | Hexo</title>
    <link rel="icon" type="image/png" href="/f/favicon.png">

    <link rel="stylesheet" type="text/css" href="/f/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/f/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/f/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/f/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/f/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/f/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/f/css/my.css">

    <script src="/f/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/f/" class="waves-effect waves-light">
                    
                    <img src="/f/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/f/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/f/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/f/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/f/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/f/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/f/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/f/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/f/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/f/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/f/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">谷粒商城分布式微服务组件K8s</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/f/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/f/tags/K8s/">
                                <span class="chip bg-color">K8s</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/f/categories/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" class="post-category">
                                谷粒商城
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-23
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    49 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/f/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1、K8s快速入门"><a href="#1、K8s快速入门" class="headerlink" title="1、K8s快速入门"></a>1、K8s快速入门</h2><h3 id="1）简介"><a href="#1）简介" class="headerlink" title="1）简介"></a>1）简介</h3><p>kubernetes简称k8s。是用于自动部署，扩展和管理容器化应用程序的开源系统。<br>中文官网：<a target="_blank" rel="noopener" href="https://kubernetes.io/Zh/">https://kubernetes.io/Zh/</a><br>中文社区：<a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/">https://www.kubernetes.org.cn/</a><br>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/home/">https://kubernetes.io/zh/docs/home/</a><br>社区文档：<a target="_blank" rel="noopener" href="https://docs.kubernetes.org.cn/">https://docs.kubernetes.org.cn/</a></p>
<p>部署方式的进化：</p>
<p> <img src="https://d33wubrfki0l68.cloudfront.net/26a177ede4d7b032362289c6fccd448fc4a91174/eb693/images/docs/container_evolution.svg" alt="部署演进"> </p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110819.png" alt="image-20200503105948619"></p>
<p><img src="images/image-20200503110101659.png" alt="image-20200503110101659"></p>
<h3 id="2）架构"><a href="#2）架构" class="headerlink" title="2）架构"></a>2）架构</h3><h4 id="（1）整体主从方式"><a href="#（1）整体主从方式" class="headerlink" title="（1）整体主从方式"></a>（1）整体主从方式</h4><p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110838.png" alt="image-20200503110244940"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110841.png" alt="image-20200503110350256"></p>
<h4 id="（2）master节点架构"><a href="#（2）master节点架构" class="headerlink" title="（2）master节点架构"></a>（2）master节点架构</h4><p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110844.png" alt="image-20200503110458806"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110848.png" alt="image-20200503110631219"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110851.png" alt="image-20200503110732773"></p>
<h4 id="（3）Node节点架构"><a href="#（3）Node节点架构" class="headerlink" title="（3）Node节点架构"></a>（3）Node节点架构</h4><p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110854.png" alt="image-20200503110804361"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110857.png" alt="image-20200503111032457"></p>
<h3 id="3）概念"><a href="#3）概念" class="headerlink" title="3）概念"></a>3）概念</h3><p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110901.png" alt="image-20200503112551188"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110904.png" alt="image-20200503112627449"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110908.png" alt="image-20200503112723747"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110911.png" alt="image-20200503112810938"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110949.png" alt="image-20200503113055314"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110953.png" alt="image-20200503113619233"></p>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824110956.png" alt="image-20200503113701902"></p>
<h3 id="4）快速体验"><a href="#4）快速体验" class="headerlink" title="4）快速体验"></a>4）快速体验</h3><h4 id="（1）安装minikube"><a href="#（1）安装minikube" class="headerlink" title="（1）安装minikube"></a>（1）安装minikube</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/minikube/releases">https://github.com/kubernetes/minikube/releases</a><br>下载minikuber-windows-amd64.exe 改名为minikube.exe<br>打开virtualBox，打开cmd<br>运行<br>minikube start –vm-driver=virtualbox –registry-mirror=<a target="_blank" rel="noopener" href="https://registry.docker-cn.com/">https://registry.docker-cn.com</a><br>等待20分钟即可。</p>
<h4 id="（2）体验nginx部署升级"><a href="#（2）体验nginx部署升级" class="headerlink" title="（2）体验nginx部署升级"></a>（2）体验nginx部署升级</h4><ol>
<li><p>提交一个nginx deployment<br>kubectl apply -f <a target="_blank" rel="noopener" href="https://k8s.io/examples/application/deployment.yaml">https://k8s.io/examples/application/deployment.yaml</a></p>
</li>
<li><p>升级 nginx deployment<br>kubectl apply -f <a target="_blank" rel="noopener" href="https://k8s.io/examples/application/deployment-update.yaml">https://k8s.io/examples/application/deployment-update.yaml</a></p>
</li>
<li><p>扩容 nginx deployment</p>
</li>
</ol>
<h2 id="2、K8s集群安装"><a href="#2、K8s集群安装" class="headerlink" title="2、K8s集群安装"></a>2、K8s集群安装</h2><h3 id="1）kubeadm"><a href="#1）kubeadm" class="headerlink" title="1）kubeadm"></a>1）kubeadm</h3><p>kubeadm是官方社区推出的一个用于快速部署kuberneters集群的工具。<br>这个工具能通过两条指令完成一个kuberneters集群的部署</p>
<p>创建一个master节点</p>
<pre class="line-numbers language-none"><code class="language-none">$ kuberneters init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将一个node节点加入到当前集群中</p>
<pre class="line-numbers language-none"><code class="language-none">$ kubeadm join &lt;Master节点的IP和端口&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="2）前置要求"><a href="#2）前置要求" class="headerlink" title="2）前置要求"></a>2）前置要求</h3><p>一台或多台机器，操作系统Centos7.x-86_x64<br>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多<br>集群中所有的机器之间网络互通<br>可以访问外网，需要拉取镜像<br>禁止Swap分区</p>
<h3 id="3）部署步骤"><a href="#3）部署步骤" class="headerlink" title="3）部署步骤"></a>3）部署步骤</h3><ol>
<li>在所有的节点上安装Docker和kubeadm</li>
<li>不是Kubernetes Master</li>
<li>部署容器网络插件</li>
<li>部署Kubernetes Node，将节点加入Kubernetes集群中</li>
<li>部署DashBoard web页面，可视化查看Kubernetes资源</li>
</ol>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824111012.png" alt="image-20200503144120720"></p>
<h3 id="4）环境准备"><a href="#4）环境准备" class="headerlink" title="4）环境准备"></a>4）环境准备</h3><h4 id="（1）准备工作"><a href="#（1）准备工作" class="headerlink" title="（1）准备工作"></a>（1）准备工作</h4><ul>
<li>我们可以使用vagrant快速创建三个虚拟机。虚拟机启动前先设置virtualbox的主机网络。现在全部统一为192.168.56.1，以后所有虚拟机都是56.x的ip地址。</li>
</ul>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824111015.png" alt="image-20200503175351320"></p>
<ul>
<li>在全局设定中，找到一个空间比较大的磁盘用用来存放镜像。 </li>
</ul>
<p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824111018.png" alt="image-20200503180202640"></p>
<h4 id="（2）启动三个虚拟机"><a href="#（2）启动三个虚拟机" class="headerlink" title="（2）启动三个虚拟机"></a>（2）启动三个虚拟机</h4><ul>
<li>使用我们提供的vagrant文件，复制到非中文无空格目录下，运行vagrant up启动三个虚拟机。其实vagrant完全可以一键部署全部K8s集群<br><a target="_blank" rel="noopener" href="https://github.com/rootsongjc/kubernetes-vagrant-centos-cluster">https://github.com/rootsongjc/kubernetes-vagrant-centos-cluster</a><br><a target="_blank" rel="noopener" href="http://github.com/davidkbainbridge/k8s-playground">http://github.com/davidkbainbridge/k8s-playground</a></li>
</ul>
<p>下面是vagrantfile，使用它来创建三个虚拟机，分别为k8s-node1，k8s-node2和k8s-node3.</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">Vagrant.configure("2") do <span class="token punctuation">|</span>config<span class="token punctuation">|</span>
   (1..3).each do <span class="token punctuation">|</span>i<span class="token punctuation">|</span>
        config.vm.define "k8s<span class="token punctuation">-</span>node<span class="token comment">#&#123;i&#125;" do |node|</span>
            <span class="token comment"># 设置虚拟机的Box</span>
            node.vm.box = "centos/7"

            <span class="token comment"># 设置虚拟机的主机名</span>
            node.vm.hostname="k8s<span class="token punctuation">-</span>node<span class="token comment">#&#123;i&#125;"</span>

            <span class="token comment"># 设置虚拟机的IP</span>
            node.vm.network "private_network"<span class="token punctuation">,</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">"192.168.56.#&#123;99+i&#125;"</span><span class="token punctuation">,</span> <span class="token key atrule">netmask</span><span class="token punctuation">:</span> <span class="token string">"255.255.255.0"</span>

            <span class="token comment"># 设置主机与虚拟机的共享目录</span>
            <span class="token comment"># node.vm.synced_folder "~/Documents/vagrant/share", "/home/vagrant/share"</span>

            <span class="token comment"># VirtaulBox相关配置</span>
            node.vm.provider "virtualbox" do <span class="token punctuation">|</span>v<span class="token punctuation">|</span>
                <span class="token comment"># 设置虚拟机的名称</span>
                v.name = "k8s<span class="token punctuation">-</span>node<span class="token comment">#&#123;i&#125;"</span>
                <span class="token comment"># 设置虚拟机的内存大小</span>
                v.memory = 4096
                <span class="token comment"># 设置虚拟机的CPU个数</span>
                v.cpus = 4
            end
        end
   end
end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li>进入到三个虚拟机，开启root的密码访问权限</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Vagrant <span class="token function">ssh</span> xxx进入到系统后

<span class="token function">su</span> root 密码为vagrant

<span class="token function">vi</span> /etc/ssh/sshd_config

修改
PermitRootLogin <span class="token function">yes</span> 
PasswordAuthentication <span class="token function">yes</span>

所有的虚拟机设为4核4G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>关于在”网络地址转换”的连接方式下，三个节点的eth0，IP地址相同的问题。</p>
<p><strong>问题描述：</strong>查看k8s-node1的路由表：</p>
<pre class="line-numbers language-none"><code class="language-none">[root@k8s-node1 ~]# ip route show
default via 10.0.2.2 dev eth0 proto dhcp metric 100 
10.0.2.0&#x2F;24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
192.168.56.0&#x2F;24 dev eth1 proto kernel scope link src 192.168.56.100 metric 101 
[root@k8s-node1 ~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>能够看到路由表中记录的是，通过端口eth0进行数据包的收发。</p>
<p>分别查看k8s-node1，k8s-node2和k8s-node3的eth0所绑定的IP地址，发现它们都是相同的，全都是10.0.2.15，这些地址是供kubernetes集群通信用的，区别于eth1上的IP地址，是通远程管理使用的。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># ip addr</span>
<span class="token punctuation">..</span>.
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">52</span>:54:00:8a:fe:e6 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.0</span>.2.15/24 brd <span class="token number">10.0</span>.2.255 scope global noprefixroute dynamic eth0
       valid_lft 84418sec preferred_lft 84418sec
    inet6 fe80::5054:ff:fe8a:fee6/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: eth1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 08:00:27:a3:ca:c0 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.56.100/24 brd <span class="token number">192.168</span>.56.255 scope global noprefixroute eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fea3:cac0/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>原因分析：</strong>这是因为它们使用是端口转发规则，使用同一个地址，通过不同的端口来区分。但是这种端口转发规则在以后的使用中会产生很多不必要的问题，所以需要修改为NAT网络类型。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>选择三个节点，然后执行“管理”-&gt;”全局设定”-&gt;“网络”，添加一个NAT网络。</li>
</ul>
<ul>
<li>分别修改每台设备的网络类型，并刷新重新生成MAC地址。</li>
</ul>
<ul>
<li>再次查看三个节点的IP</li>
</ul>
<img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824111049.png" alt="image-20200503190101156" style="zoom:50%;" />





<h4 id="（3）设置Linux环境（三个节点都执行）"><a href="#（3）设置Linux环境（三个节点都执行）" class="headerlink" title="（3）设置Linux环境（三个节点都执行）"></a>（3）设置Linux环境（三个节点都执行）</h4><ul>
<li>关闭防火墙</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl stop firewalld
systemctl disable firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>关闭Linux</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">sed -i &#39;s&#x2F;enforcing&#x2F;disabled&#x2F;&#39; &#x2F;etc&#x2F;selinux&#x2F;config
setenforce 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>关闭swap </li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">swapoff -a <span class="token comment">#临时关闭</span>
<span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab <span class="token comment">#永久关闭</span>
<span class="token function">free</span> -g <span class="token comment">#验证，swap必须为0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>添加主机名与IP对应关系：</li>
</ul>
<p>查看主机名：</p>
<pre class="line-numbers language-none"><code class="language-none">hostname<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果主机名不正确，可以通过“hostnamectl set-hostname &lt;newhostname&gt; :指定新的hostname”命令来进行修改。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">vi</span> /etc/hosts
<span class="token number">10.0</span>.2.15 k8s-node1
<span class="token number">10.0</span>.2.4 k8s-node2
<span class="token number">10.0</span>.2.5 k8s-node3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>将桥接的IPV4流量传递到iptables的链：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> <span class="token operator">></span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF

net.bridge.bridge-nf-call-ip6tables = 1

net.bridge.bridge-nf-call-iptables = 1

EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>应用规则：</p>
<pre class="line-numbers language-none"><code class="language-none">sysctl --system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<p>疑难问题：遇见提示是只读的文件系统，运行如下命令</p>
<pre class="line-numbers language-none"><code class="language-none">mount -o remount rw &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>date 查看时间（可选）</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum -y <span class="token function">install</span> ntpupdate

ntpupdate time.window.com <span class="token comment">#同步最新时间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="5）所有节点安装docker、kubeadm、kubelet、kubectl"><a href="#5）所有节点安装docker、kubeadm、kubelet、kubectl" class="headerlink" title="5）所有节点安装docker、kubeadm、kubelet、kubectl"></a>5）所有节点安装docker、kubeadm、kubelet、kubectl</h3><p>Kubenetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h4 id="（1）安装Docker"><a href="#（1）安装Docker" class="headerlink" title="（1）安装Docker"></a>（1）安装Docker</h4><p>1、卸载之前的docker</p>
<pre class="line-numbers language-none"><code class="language-none">$ sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、安装Docker  -CE</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils

$ <span class="token function">sudo</span> yum-config-manager <span class="token punctuation">\</span>
    --add-repo <span class="token punctuation">\</span>
    https://download.docker.com/linux/centos/docker-ce.repo
    
$ <span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce docker-ce-cli containerd.io   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、配置镜像加速</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
&#123;
  "registry-mirrors": ["https://ke9h1pt4.mirror.aliyuncs.com"]
&#125;
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、启动Docker &amp;&amp; 设置docker开机启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl <span class="token builtin class-name">enable</span> docker<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>基础环境准备好，可以给三个虚拟机备份一下；</p>
<h4 id="（2）添加阿里与Yum源"><a href="#（2）添加阿里与Yum源" class="headerlink" title="（2）添加阿里与Yum源"></a>（2）添加阿里与Yum源</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>更多详情见： <a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes">https://developer.aliyun.com/mirror/kubernetes</a> </p>
<h4 id="（3）安装kubeadm，kubelet和kubectl"><a href="#（3）安装kubeadm，kubelet和kubectl" class="headerlink" title="（3）安装kubeadm，kubelet和kubectl"></a>（3）安装kubeadm，kubelet和kubectl</h4><pre class="line-numbers language-none"><code class="language-none">yum list|grep kube<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum <span class="token function">install</span> -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>开机启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>查看kubelet的状态：</p>
<pre class="line-numbers language-none"><code class="language-none">systemctl status kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看kubelet版本：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># kubelet --version</span>
Kubernetes v1.17.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="6）部署k8s-master"><a href="#6）部署k8s-master" class="headerlink" title="6）部署k8s-master"></a>6）部署k8s-master</h3><h4 id="（1）master节点初始化"><a href="#（1）master节点初始化" class="headerlink" title="（1）master节点初始化"></a>（1）master节点初始化</h4><p>在Master节点上，创建并执行master_images.sh</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#!&#x2F;bin&#x2F;bash

images&#x3D;(
	kube-apiserver:v1.17.3
    kube-proxy:v1.17.3
	kube-controller-manager:v1.17.3
	kube-scheduler:v1.17.3
	coredns:1.6.5
	etcd:3.4.3-0
    pause:3.1
)

for imageName in $&#123;images[@]&#125; ; do
    docker pull registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;$imageName
#   docker tag registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;$imageName  k8s.gcr.io&#x2F;$imageName
done<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<p>初始化kubeadm</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ kubeadm init <span class="token punctuation">\</span>
--apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.2.15 <span class="token punctuation">\</span>
--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="token punctuation">\</span>
--kubernetes-version   v1.17.3 <span class="token punctuation">\</span>
--service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/16  <span class="token punctuation">\</span>
--pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：</p>
<ul>
<li>–apiserver-advertise-address=10.0.2.21 ：这里的IP地址是master主机的地址，为上面的eth0网卡的地址；</li>
<li></li>
</ul>
<p>执行结果：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># kubeadm init \</span>
<span class="token operator">></span> --apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.2.15 <span class="token punctuation">\</span>
<span class="token operator">></span> --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span class="token punctuation">\</span>
<span class="token operator">></span> --kubernetes-version   v1.17.3 <span class="token punctuation">\</span>
<span class="token operator">></span> --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/16  <span class="token punctuation">\</span>
<span class="token operator">></span> --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
W0503 <span class="token number">14</span>:07:12.594252   <span class="token number">10124</span> configset.go:202<span class="token punctuation">]</span> WARNING: kubeadm cannot validate component configs <span class="token keyword">for</span> API <span class="token function">groups</span> <span class="token punctuation">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span class="token punctuation">]</span>
<span class="token punctuation">[</span>init<span class="token punctuation">]</span> Using Kubernetes version: v1.17.3
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
        <span class="token punctuation">[</span>WARNING IsDockerSystemdCheck<span class="token punctuation">]</span>: detected <span class="token string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="token string">"systemd"</span><span class="token builtin class-name">.</span> Please follow the guide at https://kubernetes.io/docs/setup/cri/
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Pulling images required <span class="token keyword">for</span> setting up a Kubernetes cluster
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> This might take a minute or two, depending on the speed of your internet connection
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> You can also perform this action <span class="token keyword">in</span> beforehand using <span class="token string">'kubeadm config images pull'</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/kubeadm-flags.env"</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/config.yaml"</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Using certificateDir folder <span class="token string">"/etc/kubernetes/pki"</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"ca"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> apiserver serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-node1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.96</span>.0.1 <span class="token number">10.0</span>.2.15<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver-kubelet-client"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"front-proxy-ca"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"front-proxy-client"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/ca"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/server"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/server serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-node1 localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.0</span>.2.15 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/peer"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> etcd/peer serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>k8s-node1 localhost<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.0</span>.2.15 <span class="token number">127.0</span>.0.1 ::1<span class="token punctuation">]</span>
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"etcd/healthcheck-client"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver-etcd-client"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"sa"</span> key and public key
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Using kubeconfig folder <span class="token string">"/etc/kubernetes"</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"admin.conf"</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"kubelet.conf"</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"controller-manager.conf"</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>kubeconfig<span class="token punctuation">]</span> Writing <span class="token string">"scheduler.conf"</span> kubeconfig <span class="token function">file</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Using manifest folder <span class="token string">"/etc/kubernetes/manifests"</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-apiserver"</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-controller-manager"</span>
W0503 <span class="token number">14</span>:07:30.908642   <span class="token number">10124</span> manifests.go:225<span class="token punctuation">]</span> the default kube-apiserver authorization-mode is <span class="token string">"Node,RBAC"</span><span class="token punctuation">;</span> using <span class="token string">"Node,RBAC"</span>
<span class="token punctuation">[</span>control-plane<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token string">"kube-scheduler"</span>
W0503 <span class="token number">14</span>:07:30.911330   <span class="token number">10124</span> manifests.go:225<span class="token punctuation">]</span> the default kube-apiserver authorization-mode is <span class="token string">"Node,RBAC"</span><span class="token punctuation">;</span> using <span class="token string">"Node,RBAC"</span>
<span class="token punctuation">[</span>etcd<span class="token punctuation">]</span> Creating static Pod manifest <span class="token keyword">for</span> <span class="token builtin class-name">local</span> etcd <span class="token keyword">in</span> <span class="token string">"/etc/kubernetes/manifests"</span>
<span class="token punctuation">[</span>wait-control-plane<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="token string">"/etc/kubernetes/manifests"</span><span class="token builtin class-name">.</span> This can take up to 4m0s
<span class="token punctuation">[</span>apiclient<span class="token punctuation">]</span> All control plane components are healthy after <span class="token number">22.506521</span> seconds
<span class="token punctuation">[</span>upload-config<span class="token punctuation">]</span> Storing the configuration used <span class="token keyword">in</span> ConfigMap <span class="token string">"kubeadm-config"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> Namespace
<span class="token punctuation">[</span>kubelet<span class="token punctuation">]</span> Creating a ConfigMap <span class="token string">"kubelet-config-1.18"</span> <span class="token keyword">in</span> namespace kube-system with the configuration <span class="token keyword">for</span> the kubelets <span class="token keyword">in</span> the cluster
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Skipping phase. Please see --upload-certs
<span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node k8s-node1 as control-plane by adding the label <span class="token string">"node-role.kubernetes.io/master=''"</span>
<span class="token punctuation">[</span>mark-control-plane<span class="token punctuation">]</span> Marking the node k8s-node1 as control-plane by adding the taints <span class="token punctuation">[</span>node-role.kubernetes.io/master:NoSchedule<span class="token punctuation">]</span>
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Using token: sg47f3.4asffoi6ijb8ljhq
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="token keyword">in</span> order <span class="token keyword">for</span> nodes to get long term certificate credentials
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> configured RBAC rules to allow certificate rotation <span class="token keyword">for</span> all node client certificates <span class="token keyword">in</span> the cluster
<span class="token punctuation">[</span>bootstrap-token<span class="token punctuation">]</span> Creating the <span class="token string">"cluster-info"</span> ConfigMap <span class="token keyword">in</span> the <span class="token string">"kube-public"</span> namespace
<span class="token punctuation">[</span>kubelet-finalize<span class="token punctuation">]</span> Updating <span class="token string">"/etc/kubernetes/kubelet.conf"</span> to point to a rotatable kubelet client certificate and key
<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: CoreDNS
<span class="token punctuation">[</span>addons<span class="token punctuation">]</span> Applied essential addon: kube-proxy
<span class="token comment">#表示kubernetes已经初始化成功了</span>
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">10.0</span>.2.15:6443 --token sg47f3.4asffoi6ijb8ljhq <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:81fccdd29970cbc1b7dc7f171ac0234d53825bdf9b05428fc9e6767436991bfb 
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>由于默认拉取镜像地址k8s.cr.io国内无法访问，这里指定阿里云仓库地址。可以手动按照我们的images.sh先拉取镜像。</p>
<p>地址变为：registry.aliyuncs.com/googole_containers也可以。<br>科普：无类别域间路由（Classless Inter-Domain Routing 、CIDR）是一个用于给用户分配IP地址以及在互联网上有效第路由IP数据包的对IP地址进行归类的方法。<br>拉取可能失败，需要下载镜像。</p>
<p>运行完成提前复制：加入集群的令牌。</p>
<h4 id="（2）测试Kubectl（主节点执行）"><a href="#（2）测试Kubectl（主节点执行）" class="headerlink" title="（2）测试Kubectl（主节点执行）"></a>（2）测试Kubectl（主节点执行）</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>详细部署文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/addons/">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ kubectl get nodes <span class="token comment">#获取所有节点</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>目前Master状态为notready。等待网络加入完成即可。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ journalctl -u kubelet <span class="token comment">#查看kubelet日志</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubeadm <span class="token function">join</span> <span class="token number">10.0</span>.2.15:6443 --token sg47f3.4asffoi6ijb8ljhq <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:81fccdd29970cbc1b7dc7f171ac0234d53825bdf9b05428fc9e6767436991bfb <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="7）安装POD网络插件（CNI）"><a href="#7）安装POD网络插件（CNI）" class="headerlink" title="7）安装POD网络插件（CNI）"></a>7）安装POD网络插件（CNI）</h3><p>在master节点上执行按照POD网络插件</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl apply -f \
https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;coreos&#x2F;flanne&#x2F;master&#x2F;Documentation&#x2F;kube-flannel.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>以上地址可能被墙，可以直接获取本地已经下载的flannel.yml运行即可，如：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f  kube-flannel.yml    </span>
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds-amd64 created
daemonset.apps/kube-flannel-ds-arm64 created
daemonset.apps/kube-flannel-ds-arm created
daemonset.apps/kube-flannel-ds-ppc64le created
daemonset.apps/kube-flannel-ds-s390x created
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同时flannel.yml中指定的images访问不到可以去docker hub找一个wget yml地址<br>vi 修改yml 所有amd64的地址修改了即可<br>等待大约3分钟<br>kubectl get pods -n kube-system 查看指定名称空间的pods<br>kubectl get pods -all-namespace 查看所有名称空间的pods</p>
<p>$ ip link set cni0 down 如果网络出现问题，关闭cni0，重启虚拟机继续测试<br>执行watch kubectl get pod -n kube-system -o wide 监控pod进度<br>等待3-10分钟，完全都是running以后继续</p>
<p>查看命名空间：</p>
<pre class="line-numbers language-none"><code class="language-none">[root@k8s-node1 k8s]# kubectl get ns
NAME              STATUS   AGE
default           Active   30m
kube-node-lease   Active   30m
kube-public       Active   30m
kube-system       Active   30m
[root@k8s-node1 k8s]#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get pods --all-namespaces       </span>
NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE
kube-system   coredns-546565776c-9sbmk            <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          31m
kube-system   coredns-546565776c-t68mr            <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          31m
kube-system   etcd-k8s-node1                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
kube-system   kube-apiserver-k8s-node1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
kube-system   kube-controller-manager-k8s-node1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
kube-system   kube-flannel-ds-amd64-6xwth         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m50s
kube-system   kube-proxy-sz2vz                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
kube-system   kube-scheduler-k8s-node1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 查看master上的节点信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME        STATUS   ROLES    AGE   VERSION
k8s-node1   Ready    master   34m   v1.17.3   <span class="token comment">#status为ready才能够执行下面的命令</span>
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后再次执行，并且分别在“k8s-node2”和“k8s-node3”上也执行这里命令：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubeadm <span class="token function">join</span> <span class="token number">10.0</span>.2.15:6443 --token sg47f3.4asffoi6ijb8ljhq <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:81fccdd29970cbc1b7dc7f171ac0234d53825bdf9b05428fc9e6767436991bfb <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes;</span>
NAME        STATUS     ROLES    AGE   VERSION
k8s-node1   Ready      master   47m   v1.17.3
k8s-node2   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   75s   v1.17.3
k8s-node3   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   76s   v1.17.3
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>监控pod进度</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">watch</span> kubectl get pod -n kube-system -o wide<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>等到所有的status都变为running状态后，再次查看节点信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get nodes;                         </span>
NAME        STATUS   ROLES    AGE     VERSION
k8s-node1   Ready    master   3h50m   v1.17.3
k8s-node2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   3h3m    v1.17.3
k8s-node3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   3h3m    v1.17.3
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="8）加入kubenetes的Node节点"><a href="#8）加入kubenetes的Node节点" class="headerlink" title="8）加入kubenetes的Node节点"></a>8）加入kubenetes的Node节点</h3><p>在node节点中执行，向集群中添加新的节点，执行在kubeadm init 输出的kubeadm join命令；<br>确保node节点成功：<br>token过期怎么办<br>kubeadm token create –print-join-command</p>
<h3 id="9）入门操作kubernetes集群"><a href="#9）入门操作kubernetes集群" class="headerlink" title="9）入门操作kubernetes集群"></a>9）入门操作kubernetes集群</h3><p>1、在主节点上部署一个tomcat</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl create deployment tomcat6 --image<span class="token operator">=</span>tomcat:6.0.53-jre8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>获取所有的资源：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                           READY   STATUS              RESTARTS   AGE
pod/tomcat6-7b84fb5fdc-cfd8g   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          41s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP   70m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tomcat6   <span class="token number">0</span>/1     <span class="token number">1</span>            <span class="token number">0</span>           41s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">0</span>       41s
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>kubectl get pods -o wide 可以获取到tomcat部署信息，能够看到它被部署到了k8s-node2上了</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get all -o wide</span>
NAME                           READY   STATUS    RESTARTS   AGE    IP           NODE        NOMINATED NODE   READINESS GATES
pod/tomcat6-7b84fb5fdc-cfd8g   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114s   <span class="token number">10.244</span>.2.2   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP   71m   <span class="token operator">&lt;</span>none<span class="token operator">></span>

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES               SELECTOR
deployment.apps/tomcat6   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           114s   tomcat       tomcat:6.0.53-jre8   <span class="token assign-left variable">app</span><span class="token operator">=</span>tomcat6

NAME                                 DESIRED   CURRENT   READY   AGE    CONTAINERS   IMAGES               SELECTOR
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       114s   tomcat       tomcat:6.0.53-jre8   <span class="token assign-left variable">app</span><span class="token operator">=</span>tomcat6,pod-template-hash<span class="token operator">=</span>7b84fb5fdc
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>查看node2节点上，下载了哪些镜像：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node2 opt<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY                                                       TAG                 IMAGE ID            CREATED             SIZE
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy   v1.17.3             0d40868643c6        <span class="token number">2</span> weeks ago         117MB
registry.cn-hangzhou.aliyuncs.com/google_containers/pause        <span class="token number">3.2</span>                 80d28bedfe5d        <span class="token number">2</span> months ago        683kB
quay.io/coreos/flannel                                           v0.11.0-amd64       ff281650a721        <span class="token number">15</span> months ago       <span class="token number">52</span>.6MB
tomcat                                                           <span class="token number">6.0</span>.53-jre8         49ab0583115a        <span class="token number">2</span> years ago         290MB
<span class="token punctuation">[</span>root@k8s-node2 opt<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>查看Node2节点上，正在运行的容器：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node2 opt<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE                                                            COMMAND                  CREATED             STATUS              PORTS               NAMES
9194cc4f0b7a        tomcat                                                           <span class="token string">"catalina.sh run"</span>        <span class="token number">2</span> minutes ago       Up <span class="token number">2</span> minutes                            k8s_tomcat_tomcat6-7b84fb5fdc-cfd8g_default_0c9ebba2-992d-4c0e-99ef-3c4c3294bc59_0
f44af0c7c345        registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2    <span class="token string">"/pause"</span>                 <span class="token number">3</span> minutes ago       Up <span class="token number">3</span> minutes                            k8s_POD_tomcat6-7b84fb5fdc-cfd8g_default_0c9ebba2-992d-4c0e-99ef-3c4c3294bc59_0
ef74c90491e4        ff281650a721                                                     <span class="token string">"/opt/bin/flanneld -…"</span>   <span class="token number">20</span> minutes ago      Up <span class="token number">20</span> minutes                           k8s_kube-flannel_kube-flannel-ds-amd64-5xs5j_kube-system_11a94346-316d-470b-9668-c15ce183abec_0
c8a524e5a193        registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy   <span class="token string">"/usr/local/bin/kube…"</span>   <span class="token number">25</span> minutes ago      Up <span class="token number">25</span> minutes                           k8s_kube-proxy_kube-proxy-mvlnk_kube-system_519de79a-e8d8-4b1c-a74e-94634cebabce_0
4590685c519a        registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2    <span class="token string">"/pause"</span>                 <span class="token number">26</span> minutes ago      Up <span class="token number">26</span> minutes                           k8s_POD_kube-flannel-ds-amd64-5xs5j_kube-system_11a94346-316d-470b-9668-c15ce183abec_0
54e00af5cde4        registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2    <span class="token string">"/pause"</span>                 <span class="token number">26</span> minutes ago      Up <span class="token number">26</span> minutes                           k8s_POD_kube-proxy-mvlnk_kube-system_519de79a-e8d8-4b1c-a74e-94634cebabce_0
<span class="token punctuation">[</span>root@k8s-node2 opt<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>在node1上执行：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME                       READY   STATUS    RESTARTS   AGE
tomcat6-7b84fb5fdc-cfd8g   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m35s

<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get pods --all-namespaces</span>
NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE
default       tomcat6-7b84fb5fdc-cfd8g            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          163m
kube-system   coredns-546565776c-9sbmk            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   coredns-546565776c-t68mr            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   etcd-k8s-node1                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   kube-apiserver-k8s-node1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   kube-controller-manager-k8s-node1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   kube-flannel-ds-amd64-5xs5j         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h6m
kube-system   kube-flannel-ds-amd64-6xwth         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h24m
kube-system   kube-flannel-ds-amd64-fvnvx         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h6m
kube-system   kube-proxy-7tkvl                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h6m
kube-system   kube-proxy-mvlnk                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h6m
kube-system   kube-proxy-sz2vz                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
kube-system   kube-scheduler-k8s-node1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h52m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>从前面看到tomcat部署在Node2上，现在模拟因为各种原因宕机的情况，将node2关闭电源，观察情况。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME        STATUS     ROLES    AGE     VERSION
k8s-node1   Ready      master   4h4m    v1.17.3
k8s-node2   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   3h18m   v1.17.3
k8s-node3   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   3h18m   v1.17.3
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -o wide</span>
NAME                       READY   STATUS    RESTARTS   AGE    IP           NODE        NOMINATED NODE   READINESS GATES
tomcat6-7b84fb5fdc-cfd8g   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          177m   <span class="token number">10.244</span>.2.2   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="images/image-20200504104925236.png" alt="image-20200504104925236"></p>
<p>2、暴露nginx访问</p>
<p>在master上执行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl expose deployment tomcat6 --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8080</span> --type<span class="token operator">=</span>NodePort <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>pod的80映射容器的8080；server会带来pod的80</p>
<p>查看服务：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        12h
tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   49s
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -o wide</span>
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE     SELECTOR
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        12h     <span class="token operator">&lt;</span>none<span class="token operator">></span>
tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   3m30s   <span class="token assign-left variable">app</span><span class="token operator">=</span>tomcat6
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <a target="_blank" rel="noopener" href="http://192.168.56.100:30526/">http://192.168.56.100:30526/</a> </p>
<p><img src="images/image-20200504105723874.png" alt="image-20200504105723874"></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                           READY   STATUS    RESTARTS   AGE
pod/tomcat6-7b84fb5fdc-qt5jm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13m

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        12h
service/tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   9m50s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tomcat6   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           11h

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       11h
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>3、动态扩容测试</p>
<p>kubectl get deployment</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment</span>
NAME      READY   UP-TO-DATE   AVAILABLE   AGE
tomcat6   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           11h
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>应用升级： kubectl set image (–help查看帮助)<br>扩容：kubectl scale –replicas=3 deployment tomcat6</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale --replicas=3 deployment tomcat6</span>
deployment.apps/tomcat6 scaled
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -o wide</span>
NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
tomcat6-7b84fb5fdc-hdgmc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s   <span class="token number">10.244</span>.2.5   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
tomcat6-7b84fb5fdc-qt5jm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m   <span class="token number">10.244</span>.1.2   k8s-node3   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
tomcat6-7b84fb5fdc-vlrh6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61s   <span class="token number">10.244</span>.2.4   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -o wide    </span>
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE   SELECTOR
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        13h   <span class="token operator">&lt;</span>none<span class="token operator">></span>
tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   16m   <span class="token assign-left variable">app</span><span class="token operator">=</span>tomcat6
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>扩容了多份，所有无论访问哪个node的指定端口，都可以访问到tomcat6</p>
<p> <a target="_blank" rel="noopener" href="http://192.168.56.101:30526/">http://192.168.56.101:30526/</a> </p>
<p><img src="images/image-20200504111008668.png" alt="image-20200504111008668"></p>
<p> <a target="_blank" rel="noopener" href="http://192.168.56.102:30526/">http://192.168.56.102:30526/</a> </p>
<p><img src="images/image-20200504111028496.png" alt="image-20200504111028496"></p>
<p>缩容：kubectl scale –replicas=2 deployment tomcat6</p>
<pre class="line-numbers language-none"><code class="language-none">[root@k8s-node1 ~]#  kubectl scale --replicas&#x3D;2 deployment tomcat6
deployment.apps&#x2F;tomcat6 scaled
[root@k8s-node1 ~]# kubectl get pods -o wide                       
NAME                       READY   STATUS        RESTARTS   AGE     IP           NODE        NOMINATED NODE   READINESS GATES
tomcat6-7b84fb5fdc-hdgmc   0&#x2F;1     Terminating   0          4m47s   &lt;none&gt;       k8s-node2   &lt;none&gt;           &lt;none&gt;
tomcat6-7b84fb5fdc-qt5jm   1&#x2F;1     Running       0          22m     10.244.1.2   k8s-node3   &lt;none&gt;           &lt;none&gt;
tomcat6-7b84fb5fdc-vlrh6   1&#x2F;1     Running       0          4m47s   10.244.2.4   k8s-node2   &lt;none&gt;           &lt;none&gt;
[root@k8s-node1 ~]# <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>4、以上操作的yaml获取<br>参照k8s细节</p>
<p>5、删除<br>kubectl get all</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#查看所有资源</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                           READY   STATUS    RESTARTS   AGE
pod/tomcat6-7b84fb5fdc-qt5jm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26m
pod/tomcat6-7b84fb5fdc-vlrh6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m16s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        13h
service/tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   22m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tomcat6   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           11h

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>       11h
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token comment">#删除deployment.apps/tomcat6 </span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete  deployment.apps/tomcat6 </span>
deployment.apps <span class="token string">"tomcat6"</span> deleted

<span class="token comment">#查看剩余的资源</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all   </span>
NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        13h
service/tomcat6      NodePort    <span class="token number">10.96</span>.24.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30526/TCP   30m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token comment">#删除service/tomcat6 </span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete service/tomcat6  </span>
<span class="token function">service</span> <span class="token string">"tomcat6"</span> deleted
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP   13h
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>kubectl delete deploye/nginx<br>kubectl delete service/nginx-service</p>
<h2 id="3、K8s细节"><a href="#3、K8s细节" class="headerlink" title="3、K8s细节"></a>3、K8s细节</h2><h3 id="1、kubectl文档"><a href="#1、kubectl文档" class="headerlink" title="1、kubectl文档"></a>1、kubectl文档</h3><p>​    <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/">https://kubernetes.io/zh/docs/reference/kubectl/overview/</a></p>
<h3 id="2、资源类型"><a href="#2、资源类型" class="headerlink" title="2、资源类型"></a>2、资源类型</h3><p>   <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/#%e8%b5%84%e6%ba%90%e7%b1%bb%e5%9e%8b">https://kubernetes.io/zh/docs/reference/kubectl/overview/#%e8%b5%84%e6%ba%90%e7%b1%bb%e5%9e%8b</a></p>
<h3 id="3、格式化输出"><a href="#3、格式化输出" class="headerlink" title="3、格式化输出"></a>3、格式化输出</h3><p> <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/">https://kubernetes.io/zh/docs/reference/kubectl/overview/</a> </p>
<blockquote>
<p>所有 <code>kubectl</code> 命令的默认输出格式都是人类可读的纯文本格式。要以特定格式向终端窗口输出详细信息，可以将 <code>-o</code> 或 <code>--output</code> 参数添加到受支持的 <code>kubectl</code> 命令中。</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token operator">></span>kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> -o<span class="token operator">=</span><span class="token operator">&lt;</span>output_format<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>根据 <code>kubectl</code> 操作，支持以下输出格式：</p>
<table>
<thead>
<tr>
<th align="left">Output format</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>-o custom-columns=</code></td>
<td align="left">使用逗号分隔的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/#custom-columns">自定义列</a>列表打印表。</td>
</tr>
<tr>
<td align="left"><code>-o custom-columns-file=</code></td>
<td align="left">使用 `` 文件中的<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/overview/#custom-columns">自定义列</a>模板打印表。</td>
</tr>
<tr>
<td align="left"><code>-o json</code></td>
<td align="left">输出 JSON 格式的 API 对象</td>
</tr>
<tr>
<td align="left">`-o jsonpath=</td>
<td align="left">打印 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/">jsonpath</a> 表达式定义的字段</td>
</tr>
<tr>
<td align="left"><code>-o jsonpath-file=</code></td>
<td align="left">打印 `` 文件中 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/jsonpath/">jsonpath</a> 表达式定义的字段。</td>
</tr>
<tr>
<td align="left"><code>-o name</code></td>
<td align="left">仅打印资源名称而不打印任何其他内容。</td>
</tr>
<tr>
<td align="left"><code>-o wide</code></td>
<td align="left">以纯文本格式输出，包含任何附加信息。对于 pod 包含节点名。</td>
</tr>
<tr>
<td align="left"><code>-o yaml</code></td>
<td align="left">输出 YAML 格式的 API 对象。</td>
</tr>
</tbody></table>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><p>在此示例中，以下命令将单个 pod 的详细信息输出为 YAML 格式的对象：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token operator">></span>kubectl get pod web-pod-13je7 -o yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>请记住：有关每个命令支持哪种输出格式的详细信息，请参阅 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/user-guide/kubectl/">kubectl</a> 参考文档。</p>
</blockquote>
<p>–dry-run：</p>
<blockquote>
<p>–dry-run=’none’: Must be “none”, “server”, or “client”. If client strategy, only print the object that would be</p>
<p>sent, without sending it. If server strategy, submit server-side request without persisting the resource.</p>
<p>值必须为none，server或client。如果是客户端策略，则只打印该发送对象，但不发送它。如果服务器策略，提交服务器端请求而不持久化资源。</p>
<p>也就是说，通过–dry-run选项，并不会真正的执行这条命令。</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment tomcat6 --image=tomcat:6.0.53-jre8 --dry-run -o yaml</span>
W0504 03<span class="token punctuation">:</span>39<span class="token punctuation">:</span>08.389369    8107 helpers.go<span class="token punctuation">:</span><span class="token number">535</span><span class="token punctuation">]</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run is deprecated and can be replaced with <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run=client.
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>6.0.53<span class="token punctuation">-</span>jre8
        <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际上我们也可以将这个yaml输出到文件，然后使用kubectl apply -f来应用它</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#输出到tomcat6.yaml </span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment tomcat6 --image=tomcat:6.0.53-jre8 --dry-run -o yaml >tomcat6.yaml</span>
W0504 03:46:18.180366   <span class="token number">11151</span> helpers.go:535<span class="token punctuation">]</span> --dry-run is deprecated and can be replaced with --dry-run<span class="token operator">=</span>client.

<span class="token comment">#修改副本数为3</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># cat tomcat6.yaml </span>
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: tomcat6
  name: tomcat6
spec:
  replicas: <span class="token number">3</span>     <span class="token comment">#修改副本数为3</span>
  selector:
    matchLabels:
      app: tomcat6
  strategy: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: tomcat6
    spec:
      containers:
      - image: tomcat:6.0.53-jre8
        name: tomcat
        resources: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
status: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">#应用tomcat6.yaml </span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f tomcat6.yaml </span>
deployment.apps/tomcat6 created
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看pods：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  </span>
NAME                       READY   STATUS    RESTARTS   AGE
tomcat6-7b84fb5fdc-5jh6t   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
tomcat6-7b84fb5fdc-8lhwv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
tomcat6-7b84fb5fdc-j4qmh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>查看某个pod的具体信息：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods tomcat6-7b84fb5fdc-5jh6t  -o yaml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:47Z"</span>
  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> tomcat6<span class="token punctuation">-</span>7b84fb5fdc<span class="token punctuation">-</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
    <span class="token key atrule">pod-template-hash</span><span class="token punctuation">:</span> 7b84fb5fdc
  <span class="token key atrule">managedFields</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">fieldsType</span><span class="token punctuation">:</span> FieldsV1
    <span class="token key atrule">fieldsV1</span><span class="token punctuation">:</span>
      <span class="token key atrule">f:metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:generateName</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">f:app</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">f:pod-template-hash</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:ownerReferences</span><span class="token punctuation">:</span>
          <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"uid"<span class="token punctuation">:</span><span class="token string">"292bfe3b-dd63-442e-95ce-c796ab5bdcc1"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:apiVersion</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:blockOwnerDeletion</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:controller</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:kind</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:name</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:uid</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">f:spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:containers</span><span class="token punctuation">:</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"name"<span class="token punctuation">:</span><span class="token string">"tomcat"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:image</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:imagePullPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:name</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:terminationMessagePath</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:terminationMessagePolicy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:dnsPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:enableServiceLinks</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:restartPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:schedulerName</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">manager</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token key atrule">operation</span><span class="token punctuation">:</span> Update
    <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:47Z"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">fieldsType</span><span class="token punctuation">:</span> FieldsV1
    <span class="token key atrule">fieldsV1</span><span class="token punctuation">:</span>
      <span class="token key atrule">f:status</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:conditions</span><span class="token punctuation">:</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"type"<span class="token punctuation">:</span><span class="token string">"ContainersReady"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastProbeTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastTransitionTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:type</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"type"<span class="token punctuation">:</span><span class="token string">"Initialized"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastProbeTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastTransitionTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:type</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"type"<span class="token punctuation">:</span><span class="token string">"Ready"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastProbeTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:lastTransitionTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:type</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:containerStatuses</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:hostIP</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:phase</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:podIP</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:podIPs</span><span class="token punctuation">:</span>
          <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          k<span class="token punctuation">:</span><span class="token punctuation">&#123;</span>"ip"<span class="token punctuation">:</span><span class="token string">"10.244.2.7"</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
            <span class="token key atrule">.</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
            <span class="token key atrule">f:ip</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">f:startTime</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">manager</span><span class="token punctuation">:</span> kubelet
    <span class="token key atrule">operation</span><span class="token punctuation">:</span> Update
    <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:49Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6<span class="token punctuation">-</span>7b84fb5fdc<span class="token punctuation">-</span>5jh6t
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">ownerReferences</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">blockOwnerDeletion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6<span class="token punctuation">-</span>7b84fb5fdc
    <span class="token key atrule">uid</span><span class="token punctuation">:</span> 292bfe3b<span class="token punctuation">-</span>dd63<span class="token punctuation">-</span>442e<span class="token punctuation">-</span>95ce<span class="token punctuation">-</span>c796ab5bdcc1
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"46229"</span>
  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /api/v1/namespaces/default/pods/tomcat6<span class="token punctuation">-</span>7b84fb5fdc<span class="token punctuation">-</span>5jh6t
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 2f661212<span class="token punctuation">-</span>3b03<span class="token punctuation">-</span>47e4<span class="token punctuation">-</span>bcb8<span class="token punctuation">-</span>79782d5c7578
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>6.0.53<span class="token punctuation">-</span>jre8
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
    <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount
      <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>token<span class="token punctuation">-</span>bxqtw
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">enableServiceLinks</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node2
  <span class="token key atrule">priority</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> default
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/unreachable
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>token<span class="token punctuation">-</span>bxqtw
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>token<span class="token punctuation">-</span>bxqtw
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:47Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Initialized
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:49Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:49Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> ContainersReady
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:47Z"</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> PodScheduled
  <span class="token key atrule">containerStatuses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">containerID</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>//18eb0798384ea44ff68712cda9be94b6fb96265206c554a15cee28c288879304
    <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>6.0.53<span class="token punctuation">-</span>jre8
    <span class="token key atrule">imageID</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>pullable<span class="token punctuation">:</span>//tomcat@sha256<span class="token punctuation">:</span>8c643303012290f89c6f6852fa133b7c36ea6fbb8eb8b8c9588a432beb24dc5d
    <span class="token key atrule">lastState</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
    <span class="token key atrule">ready</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restartCount</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">started</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span>
      <span class="token key atrule">running</span><span class="token punctuation">:</span>
        <span class="token key atrule">startedAt</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:49Z"</span>
  <span class="token key atrule">hostIP</span><span class="token punctuation">:</span> 10.0.2.4
  <span class="token key atrule">phase</span><span class="token punctuation">:</span> Running
  <span class="token key atrule">podIP</span><span class="token punctuation">:</span> 10.244.2.7
  <span class="token key atrule">podIPs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.244.2.7
  <span class="token key atrule">qosClass</span><span class="token punctuation">:</span> BestEffort
  <span class="token key atrule">startTime</span><span class="token punctuation">:</span> <span class="token string">"2020-05-04T03:50:47Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h3 id="命令参考"><a href="#命令参考" class="headerlink" title="命令参考"></a>命令参考</h3><p><img src="images/image-20200504115823058.png" alt="image-20200504115823058"></p>
<h3 id="service的意义"><a href="#service的意义" class="headerlink" title="service的意义"></a>service的意义</h3><p><img src="https://gitee.com/fengylf/pubtypora/raw/master/img/20210824111120.png" alt="image-20200504120856830"></p>
<p>前面我们通过命令行的方式，部署和暴露了tomcat，实际上也可以通过yaml的方式来完成这些操作。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#这些操作实际上是为了获取Deployment的yaml模板</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl create deployment tomcat6 --image=tomcat:6.0.53-jre8 --dry-run -o yaml >tomcat6-deployment.yaml</span>
W0504 04:13:28.265432   <span class="token number">24263</span> helpers.go:535<span class="token punctuation">]</span> --dry-run is deprecated and can be replaced with --dry-run<span class="token operator">=</span>client.
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># ls tomcat6-deployment.yaml</span>
tomcat6-deployment.yaml
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改“tomcat6-deployment.yaml”内容如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>6.0.53<span class="token punctuation">-</span>jre8
        <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#部署</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f tomcat6-deployment.yaml</span>
deployment.apps/tomcat6 configured


<span class="token comment">#查看资源</span>
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                           READY   STATUS    RESTARTS   AGE
pod/tomcat6-7b84fb5fdc-5jh6t   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
pod/tomcat6-7b84fb5fdc-8lhwv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
pod/tomcat6-7b84fb5fdc-j4qmh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP   14h

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tomcat6   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           27m

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       27m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl expose deployment tomcat6 --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">8080</span> --type<span class="token operator">=</span>NodePort  --dry-run -o yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>将这段输出和“tomcat6-deployment.yaml”进行拼接，表示部署完毕并进行暴露服务：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>6.0.53<span class="token punctuation">-</span>jre8
        <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat6
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat6
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>部署并暴露服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f tomcat6-deployment.yaml</span>
deployment.apps/tomcat6 created
service/tomcat6 created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>查看服务和部署信息</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all</span>
NAME                           READY   STATUS    RESTARTS   AGE
pod/tomcat6-7b84fb5fdc-dsqmb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4s
pod/tomcat6-7b84fb5fdc-gbmxc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pod/tomcat6-7b84fb5fdc-kjlc6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP        14h
service/tomcat6      NodePort    <span class="token number">10.96</span>.147.210   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30172/TCP   4s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tomcat6   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           5s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/tomcat6-7b84fb5fdc   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       5s
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问node1，node1和node3的30172端口：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -I http://192.168.56.&#123;100,101,102&#125;:30172/</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: Apache-Coyote/1.1
Accept-Ranges: bytes
ETag: W/<span class="token string">"7454-1491118183000"</span>
Last-Modified: Sun, 02 Apr <span class="token number">2017</span> 07:29:43 GMT
Content-Type: text/html
Content-Length: <span class="token number">7454</span>
Date: Mon, 04 May <span class="token number">2020</span> 04:35:35 GMT

HTTP/1.1 <span class="token number">200</span> OK
Server: Apache-Coyote/1.1
Accept-Ranges: bytes
ETag: W/<span class="token string">"7454-1491118183000"</span>
Last-Modified: Sun, 02 Apr <span class="token number">2017</span> 07:29:43 GMT
Content-Type: text/html
Content-Length: <span class="token number">7454</span>
Date: Mon, 04 May <span class="token number">2020</span> 04:35:35 GMT

HTTP/1.1 <span class="token number">200</span> OK
Server: Apache-Coyote/1.1
Accept-Ranges: bytes
ETag: W/<span class="token string">"7454-1491118183000"</span>
Last-Modified: Sun, 02 Apr <span class="token number">2017</span> 07:29:43 GMT
Content-Type: text/html
Content-Length: <span class="token number">7454</span>
Date: Mon, 04 May <span class="token number">2020</span> 04:35:35 GMT

<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>通过Ingress发现pod进行关联。基于域名访问<br>通过Ingress controller实现POD负载均衡<br>支持TCP/UDP 4层负载均衡和HTTP 7层负载均衡</p>
<p><img src="images/image-20200504123948771.png" alt="image-20200504123948771"></p>
<p>步骤：<br>（1）部署Ingress controller</p>
<p>执行“k8s/ingress-controller.yaml”</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ingress-controller.yaml </span>
namespace/ingress-nginx created
configmap/nginx-configuration created
configmap/tcp-services created
configmap/udp-services created
serviceaccount/nginx-ingress-serviceaccount created
clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole created
role.rbac.authorization.k8s.io/nginx-ingress-role created
rolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-binding created
clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding created
daemonset.apps/nginx-ingress-controller created
service/ingress-nginx created
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>查看</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl get pods --all-namespaces</span>
NAMESPACE       NAME                                READY   STATUS              RESTARTS   AGE
default         tomcat6-7b84fb5fdc-dsqmb            <span class="token number">1</span>/1     Running             <span class="token number">0</span>          16m
default         tomcat6-7b84fb5fdc-gbmxc            <span class="token number">1</span>/1     Running             <span class="token number">0</span>          16m
default         tomcat6-7b84fb5fdc-kjlc6            <span class="token number">1</span>/1     Running             <span class="token number">0</span>          16m
ingress-nginx   nginx-ingress-controller-9q6cs      <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          40s
ingress-nginx   nginx-ingress-controller-qx572      <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          40s
kube-system     coredns-546565776c-9sbmk            <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     coredns-546565776c-t68mr            <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     etcd-k8s-node1                      <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     kube-apiserver-k8s-node1            <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     kube-controller-manager-k8s-node1   <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     kube-flannel-ds-amd64-5xs5j         <span class="token number">1</span>/1     Running             <span class="token number">2</span>          13h
kube-system     kube-flannel-ds-amd64-6xwth         <span class="token number">1</span>/1     Running             <span class="token number">2</span>          14h
kube-system     kube-flannel-ds-amd64-fvnvx         <span class="token number">1</span>/1     Running             <span class="token number">1</span>          13h
kube-system     kube-proxy-7tkvl                    <span class="token number">1</span>/1     Running             <span class="token number">1</span>          13h
kube-system     kube-proxy-mvlnk                    <span class="token number">1</span>/1     Running             <span class="token number">2</span>          13h
kube-system     kube-proxy-sz2vz                    <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
kube-system     kube-scheduler-k8s-node1            <span class="token number">1</span>/1     Running             <span class="token number">1</span>          14h
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里master节点负责调度，具体执行交给node2和node3来完成，能够看到它们正在下载镜像</p>
<p><img src="images/image-20200504124608258.png" alt="image-20200504124608258"></p>
<p>（2）创建Ingress规则</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat6.kubenetes.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
       <span class="token key atrule">paths</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span> 
              <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat6
              <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># touch ingress-tomcat6.yaml</span>
<span class="token comment">#将上面的规则，添加到ingress-tomcat6.yaml文件中</span>
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># vi  ingress-tomcat6.yaml  </span>
 
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ingress-tomcat6.yaml </span>
ingress.extensions/web created
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改本机的hosts文件，添加如下的域名转换规则：</p>
<pre class="line-numbers language-none"><code class="language-none">192.168.56.102 tomcat6.kubenetes.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>测试: <a target="_blank" rel="noopener" href="http://tomcat6.kubenetes.com/">http://tomcat6.kubenetes.com/</a> </p>
<p><img src="images/image-20200504131325267.png" alt="image-20200504131325267"></p>
<p>并且集群中即便有一个节点不可用，也不影响整体的运行。</p>
<h2 id="安装kubernetes可视化界面——DashBoard"><a href="#安装kubernetes可视化界面——DashBoard" class="headerlink" title="安装kubernetes可视化界面——DashBoard"></a>安装kubernetes可视化界面——DashBoard</h2><p>1、部署DashBoard</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ kubectl appy -f  kubernetes-dashboard.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 文件在“k8s”源码目录提供</p>
<p>2、暴露DashBoard为公共访问</p>
<p>默认DashBoard只能集群内部访问，修改Service为NodePort类型，暴露到外部</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问地址：<a target="_blank" rel="noopener" href="http://nodeip:30001/">http://NodeIP:30001</a></p>
<p>3、创建授权账号</p>
<pre class="line-numbers language-none"><code class="language-none">$ kubectl create serviceaccount dashboar-admin -n kube-sysem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">$ kubectl create clusterrolebinding dashboar-admin --clusterrole&#x3D;cluter-admin --serviceaccount&#x3D;kube-system:dashboard-admin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">$ kubectl describe secrets -n kube-system $( kubectl -n kube-system get secret |awk &#39;&#x2F;dashboard-admin&#x2F;&#123;print $1&#125;&#39; )<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用输出的token登录dashboard</p>
<p><img src="images/image-20200504153630775.png" alt="image-20200504153630775"></p>
<h2 id="kubesphere"><a href="#kubesphere" class="headerlink" title="kubesphere"></a>kubesphere</h2><p>默认的dashboard没啥用，我们用kubesphere可以打通全部的devops链路，kubesphere集成了很多套件，集群要求比较高<br><a target="_blank" rel="noopener" href="https://kubesphere.io/">https://kubesphere.io</a></p>
<p>kuboard也很不错，集群要求不高<br><a target="_blank" rel="noopener" href="https://kuboard.cn/support/">https://kuboard.cn/support/</a></p>
<h3 id="1、简洁"><a href="#1、简洁" class="headerlink" title="1、简洁"></a>1、简洁</h3><p>kubesphere是一款面向云原声设计的开源项目，在目前主流容器调度平台kubernets智商构建的分布式多用户容器管理平台，提供简单易用的操作界面以及向导式操作方式，在降低用户使用容器调度平台学习成本的同时，极大降低开发、测试、运维的日常工作的复杂度。</p>
<h3 id="2、安装前提提交"><a href="#2、安装前提提交" class="headerlink" title="2、安装前提提交"></a>2、安装前提提交</h3><h4 id="1、安装helm（master节点执行）"><a href="#1、安装helm（master节点执行）" class="headerlink" title="1、安装helm（master节点执行）"></a>1、安装helm（master节点执行）</h4><p>helm是kubernetes的包管理器。包管理器类似于在Ubuntu中使用的apt，centos中的yum或者python中的pip一样，能够快速查找，下载和安装软件包。Helm有客户端组件helm和服务端组件Tiller组成，能够将一组K8S资源打包统一管理，是查找、共享和使用为Kubernetes构建的软件的最佳方式。</p>
<p>1）安装</p>
<pre class="line-numbers language-none"><code class="language-none">curl -L https:&#x2F;&#x2F;git.io&#x2F;get_helm.sh|bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于被墙的原因，使用我们给定的get_helm.sh。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">68</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">7149</span> Feb <span class="token number">27</span> 01:58 get_helm.sh
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">6310</span> Feb <span class="token number">28</span> 05:16 ingress-controller.yaml
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">209</span> Feb <span class="token number">28</span> <span class="token number">13</span>:18 ingress-demo.yml
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">236</span> May  <span class="token number">4</span> 05:09 ingress-tomcat6.yaml
-rwxr--r-- <span class="token number">1</span> root root <span class="token number">15016</span> Feb <span class="token number">26</span> <span class="token number">15</span>:05 kube-flannel.yml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">4737</span> Feb <span class="token number">26</span> <span class="token number">15</span>:38 kubernetes-dashboard.yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3841</span> Feb <span class="token number">27</span> 01:09 kubesphere-complete-setup.yaml
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">392</span> Feb <span class="token number">28</span> <span class="token number">11</span>:33 master_images.sh
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">283</span> Feb <span class="token number">28</span> <span class="token number">11</span>:34 node_images.sh
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1053</span> Feb <span class="token number">28</span> 03:53 product.yaml
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">931</span> May  <span class="token number">3</span> <span class="token number">10</span>:08 Vagrantfile
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># sh get_helm.sh </span>
Downloading https://get.helm.sh/helm-v2.16.6-linux-amd64.tar.gz
Preparing to <span class="token function">install</span> helm and tiller into /usr/local/bin
helm installed into /usr/local/bin/helm
tiller installed into /usr/local/bin/tiller
Run <span class="token string">'helm init'</span> to configure helm.
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2）验证版本</p>
<pre class="line-numbers language-none"><code class="language-none">helm version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>3）创建权限（master执行）</p>
<p>创建helm-rbac.yaml，写入如下内容</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tiller
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tiller
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>应用配置：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f helm-rbac.yaml</span>
serviceaccount/tiller created
clusterrolebinding.rbac.authorization.k8s.io/tiller created
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="2、安装Tilller（Master执行）"><a href="#2、安装Tilller（Master执行）" class="headerlink" title="2、安装Tilller（Master执行）"></a>2、安装Tilller（Master执行）</h4><p>1、初始化</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># helm init --service-account=tiller --tiller-image=sapcc/tiller:v2.16.3 --history-max 300 </span>
Creating /root/.helm 
Creating /root/.helm/repository 
Creating /root/.helm/repository/cache 
Creating /root/.helm/repository/local 
Creating /root/.helm/plugins 
Creating /root/.helm/starters 
Creating /root/.helm/cache/archive 
Creating /root/.helm/repository/repositories.yaml 
Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com 
Adding <span class="token builtin class-name">local</span> repo with URL: http://127.0.0.1:8879/charts 
<span class="token variable">$HELM_HOME</span> has been configured at /root/.helm.

Tiller <span class="token punctuation">(</span>the Helm server-side component<span class="token punctuation">)</span> has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure <span class="token string">'allow unauthenticated users'</span> policy.
To prevent this, run <span class="token variable"><span class="token variable">`</span>helm init<span class="token variable">`</span></span> with the --tiller-tls-verify flag.
For <span class="token function">more</span> information on securing your installation see: https://v2.helm.sh/docs/securing_installation/
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>–tiller-image 指定镜像，否则会被墙，等待节点上部署的tiller完成即可。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n kube-system</span>
NAME                                   READY   STATUS             RESTARTS   AGE
coredns-546565776c-9sbmk               <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
coredns-546565776c-t68mr               <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
etcd-k8s-node1                         <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
kube-apiserver-k8s-node1               <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
kube-controller-manager-k8s-node1      <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
kube-flannel-ds-amd64-5xs5j            <span class="token number">1</span>/1     Running            <span class="token number">4</span>          22h
kube-flannel-ds-amd64-6xwth            <span class="token number">1</span>/1     Running            <span class="token number">5</span>          23h
kube-flannel-ds-amd64-fvnvx            <span class="token number">1</span>/1     Running            <span class="token number">4</span>          22h
kube-proxy-7tkvl                       <span class="token number">1</span>/1     Running            <span class="token number">3</span>          22h
kube-proxy-mvlnk                       <span class="token number">1</span>/1     Running            <span class="token number">4</span>          22h
kube-proxy-sz2vz                       <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
kube-scheduler-k8s-node1               <span class="token number">1</span>/1     Running            <span class="token number">3</span>          23h
kubernetes-dashboard-975499656-jxczv   <span class="token number">0</span>/1     ImagePullBackOff   <span class="token number">0</span>          7h45m
tiller-deploy-8cc566858-67bxb          <span class="token number">1</span>/1     Running            <span class="token number">0</span>          31s
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>查看集群的所有节点信息：</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl get node -o wide<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment">#  kubectl get node -o wide</span>
NAME        STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
k8s-node1   Ready    master   23h   v1.17.3   <span class="token number">10.0</span>.2.15     <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-957.12.2.el7.x86_64   docker://19.3.8
k8s-node2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   22h   v1.17.3   <span class="token number">10.0</span>.2.4      <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-957.12.2.el7.x86_64   docker://19.3.8
k8s-node3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   22h   v1.17.3   <span class="token number">10.0</span>.2.5      <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-957.12.2.el7.x86_64   docker://19.3.8
<span class="token punctuation">[</span>root@k8s-node1 k8s<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>2、测试</p>
<pre class="line-numbers language-none"><code class="language-none">helm install stable&#x2F;nginx-ingress --name nginx-ingress<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<p>最小化安装 KubeSphere</p>
<p>若集群可用 CPU &gt; 1 Core 且可用内存 &gt; 2 G，可以使用以下命令最小化安装 KubeSphere：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f https<span class="token punctuation">:</span>//raw.githubusercontent.com/kubesphere/ks<span class="token punctuation">-</span>installer/master/kubesphere<span class="token punctuation">-</span>minimal.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> <strong>提示：若您的服务器提示无法访问 GitHub，可将</strong> <a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/blob/master/kubesphere-minimal.yaml">kubesphere-minimal.yaml</a> <strong>或</strong> <a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/blob/master/kubesphere-complete-setup.yaml">kubesphere-complete-setup.yaml</a> <strong>文件保存到本地作为本地的静态文件，再参考上述命令进行安装。</strong> </p>
<ol>
<li>查看滚动刷新的安装日志，请耐心等待安装成功。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl logs -n kubesphere-system <span class="token variable"><span class="token variable">$(</span>kubectl get pod -n kubesphere-system -l <span class="token assign-left variable">app</span><span class="token operator">=</span>ks-install -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'&#123;.items[0].metadata.name&#125;'</span><span class="token variable">)</span></span> -f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>说明：安装过程中若遇到问题，也可以通过以上日志命令来排查问题。</p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/f/about" rel="external nofollow noreferrer">摩托</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://fengylf.github.io/f/f/2021/08/23/note/springboot/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4K8s/">https://fengylf.github.io/f/f/2021/08/23/note/springboot/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4K8s/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/f/about" target="_blank">摩托</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/f/tags/K8s/">
                                    <span class="chip bg-color">K8s</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/f/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/f/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/f/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/f/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/f/2021/08/23/note/springboot/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80/">
                    <div class="card-image">
                        
                        
                        <img src="/f/medias/featureimages/21.jpg" class="responsive-img" alt="谷粒商城分布式基础">
                        
                        <span class="card-title">谷粒商城分布式基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/f/categories/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" class="post-category">
                                    谷粒商城
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/f/tags/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/">
                        <span class="chip bg-color">谷粒商城</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/f/2021/08/23/note/springboot/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8Eelastic%20search/">
                    <div class="card-image">
                        
                        
                        <img src="/f/medias/featureimages/8.jpg" class="responsive-img" alt="谷粒商城分布式微服务组件ELASTICSEARCH">
                        
                        <span class="card-title">谷粒商城分布式微服务组件ELASTICSEARCH</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-08-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/f/categories/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" class="post-category">
                                    谷粒商城
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/f/tags/ELASTICSEARCH/">
                        <span class="chip bg-color">ELASTICSEARCH</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/f/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/f/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/f/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/f/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/f/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/f/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/f/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/f/about" target="_blank">摩托</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">329.5k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1300379737@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1300379737" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1300379737" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/f/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/f/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/f/libs/materialize/materialize.min.js"></script>
    <script src="/f/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/f/libs/aos/aos.js"></script>
    <script src="/f/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/f/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/f/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/f/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/f/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/f/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
